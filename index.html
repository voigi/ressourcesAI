<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploration IA - Classe de 3ème</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        .resource-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .resource-card:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.05);
        }

        .type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        
        .type-badge:active { transform: scale(0.95); }

        .type-video { background: #fee2e2; color: #dc2626; }
        .type-text { background: #e0f2fe; color: #0284c7; }
        .type-image { background: #fef3c7; color: #d97706; }
        .type-interactive { background: #dcfce7; color: #16a34a; }
        .type-audio { background: #f3e8ff; color: #7e22ce; }

        .session-container {
            border-left: 3px solid #6366f1;
            padding-left: 2rem;
            margin-bottom: 4rem;
            position: relative;
        }

        .admin-btn-disabled {
            opacity: 0.3;
            cursor: not-allowed !important;
            filter: grayscale(1);
            pointer-events: none;
        }

        .edit-mode .admin-btn-disabled {
            opacity: 1;
            cursor: pointer !important;
            filter: none;
            pointer-events: auto;
        }

        .edit-mode [contenteditable="true"] {
            outline: 2px dashed #6366f1;
            outline-offset: 4px;
            background: #f8fafc;
            border-radius: 4px;
            cursor: text;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        #viewerModal .modal-content {
            width: 95%;
            height: 90%;
            max-width: 1100px;
            background: #111;
            border-radius: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #333;
        }

        .error-shake {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .hero-gradient {
            background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
        }

        .thumbnail-container {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
        }

        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ext-chip {
            @apply px-1.5 py-0.5 rounded text-[9px] font-mono font-bold uppercase;
        }
        .ext-video { @apply bg-red-100 text-red-700 border border-red-200; }
        .ext-audio { @apply bg-purple-100 text-purple-700 border border-purple-200; }
        .ext-text { @apply bg-blue-100 text-blue-700 border border-blue-200; }
        .ext-image { @apply bg-amber-100 text-amber-700 border border-amber-200; }

        .audio-player-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(to bottom, #1e1b4b, #000);
            color: white;
            padding: 2rem;
        }
        
        .audio-visualizer-mock {
            display: flex;
            gap: 4px;
            align-items: center;
            height: 60px;
            margin-bottom: 2rem;
        }
        
        .audio-bar {
            width: 4px;
            background: #6366f1;
            border-radius: 2px;
            animation: audioBounce 1s infinite ease-in-out;
        }

        @keyframes audioBounce {
            0%, 100% { height: 10px; }
            50% { height: 50px; }
        }

        .h5p-logo {
            display: inline-flex;
            align-items: center;
            background: #255c99;
            color: white;
            font-weight: 900;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 2px;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- Modal Admin Pwd -->
    <div id="passwordModal" class="modal-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 border border-slate-200">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-lock text-indigo-600"></i> Code Administrateur
            </h3>
            <p class="text-slate-500 text-xs mb-4">Entrez le mot de passe "admin" pour éditer.</p>
            <input type="password" id="adminPwd" class="w-full px-4 py-2 border border-slate-300 rounded-lg mb-4 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Mot de passe">
            <div class="flex gap-3">
                <button id="cancelPwd" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition">Annuler</button>
                <button id="confirmPwd" class="flex-1 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">Déverrouiller</button>
            </div>
        </div>
    </div>

    <!-- Modal Source Link -->
    <div id="linkModal" class="modal-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-2 text-slate-800">Configuration de la source</h3>
            <p id="modalErrorMessage" class="text-red-500 text-[10px] font-bold uppercase hidden mb-4"><i class="fas fa-exclamation-triangle mr-1"></i> Erreur : Source non valide.</p>
            
            <div class="space-y-4">
                <div class="p-4 bg-indigo-50 border border-indigo-100 rounded-xl">
                    <div class="flex flex-col gap-2 mb-3">
                        <label class="block text-sm font-bold text-indigo-900">Lien Distant</label>
                        <div class="flex flex-wrap items-center gap-3 bg-white/50 p-2 rounded-lg border border-indigo-100">
                            <div class="flex items-center gap-1.5 grayscale hover:grayscale-0 transition cursor-default">
                                <i class="fab fa-youtube text-red-600 text-lg"></i>
                                <span class="text-[9px] font-bold text-slate-600 uppercase">YouTube</span>
                            </div>
                            <div class="w-px h-3 bg-indigo-200"></div>
                            <div class="flex items-center gap-1.5 grayscale hover:grayscale-0 transition cursor-default">
                                <i class="fas fa-globe text-blue-500 text-base"></i>
                                <span class="text-[9px] font-bold text-slate-600 uppercase">Web</span>
                            </div>
                            <div class="w-px h-3 bg-indigo-200"></div>
                            <div class="flex items-center gap-1.5 grayscale hover:grayscale-0 transition cursor-default">
                                <span class="h5p-logo">H5P</span>
                                <span class="text-[9px] font-bold text-slate-600 uppercase">H5P Content</span>
                            </div>
                        </div>
                    </div>
                    <input type="text" id="urlInput" class="w-full px-4 py-2 border border-indigo-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-white" placeholder="https://...">
                </div>

                <div class="text-center text-xs font-bold text-slate-300 flex items-center gap-4">
                    <div class="h-px bg-slate-200 flex-1"></div> OU <div class="h-px bg-slate-200 flex-1"></div>
                </div>

                <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Importer un fichier local</label>
                    <input type="file" id="fileInput" accept=".pdf,.mp4,.png,.jpg,.jpeg,.gif,.mp3,.wav,.ogg" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-200 file:text-slate-700 hover:file:bg-slate-300 mb-4">
                    
                    <div class="space-y-3 border-t border-slate-200 pt-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 text-left tracking-wider">Formats supportés :</p>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                            <div class="flex flex-col gap-1">
                                <span class="text-[9px] font-bold text-red-500 uppercase">Vidéo</span>
                                <div class="flex flex-wrap gap-1"><span class="ext-chip ext-video">.mp4</span></div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-[9px] font-bold text-purple-500 uppercase">Audio</span>
                                <div class="flex flex-wrap gap-1">
                                    <span class="ext-chip ext-audio">.mp3</span>
                                    <span class="ext-chip ext-audio">.wav</span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-[9px] font-bold text-blue-500 uppercase">Document</span>
                                <div class="flex flex-wrap gap-1"><span class="ext-chip ext-text">.pdf</span></div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-[9px] font-bold text-amber-500 uppercase">Image</span>
                                <div class="flex flex-wrap gap-1">
                                    <span class="ext-chip ext-image">.jpg</span>
                                    <span class="ext-chip ext-image">.png</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="cancelLink" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition text-sm font-medium">Annuler</button>
                <button id="saveLink" class="flex-1 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition text-sm">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Modal Lecteur -->
    <div id="viewerModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between p-4 bg-white border-b border-slate-200">
                <div>
                    <h3 id="viewerTitle" class="font-bold text-slate-800">Titre</h3>
                    <span id="viewerType" class="text-[10px] uppercase font-bold text-slate-400">Type</span>
                </div>
                <div class="flex items-center gap-3">
                    <a id="externalLink" href="#" target="_blank" class="text-xs bg-slate-100 hover:bg-indigo-100 text-slate-600 px-3 py-2 rounded-lg transition font-bold">
                        <i class="fas fa-external-link-alt mr-1"></i> Ouvrir à part
                    </a>
                    <button id="closeViewer" class="text-slate-400 hover:text-red-500 text-2xl px-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="viewerBody" class="flex-1 bg-black overflow-hidden relative"></div>
        </div>
    </div>

    <!-- Toolbar Admin -->
    <div class="bg-slate-900 text-white py-2 px-4 sticky top-0 z-[60] flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-1.5">
                <div id="lockIcon" class="w-2 h-2 rounded-full bg-red-500"></div>
                <span id="editStatusText" class="text-[10px] font-bold uppercase tracking-widest text-slate-500">Mode Consultation</span>
            </div>
            <button id="toggleEdit" class="bg-slate-800 hover:bg-indigo-600 px-4 py-1 rounded text-xs font-bold transition flex items-center gap-2">
                <i id="lockBtnIcon" class="fas fa-lock text-[10px]"></i> <span id="btnText">Déverrouiller l'édition</span>
            </button>
        </div>
        <div id="saveStatus" class="text-[10px] text-slate-500 font-bold uppercase">Lecture seule</div>
    </div>

    <nav class="bg-white border-b py-4 px-6">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 font-black text-xl tracking-tighter">
                <span class="bg-indigo-600 text-white px-2 py-0.5 rounded shadow-sm">IA</span> LAB 3ème
            </div>
            <div id="dynamicNavLinks" class="hidden md:flex gap-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest">
            </div>
        </div>
    </nav>

    <header class="hero-gradient border-b border-slate-200 py-10 px-6">
        <div class="max-w-5xl mx-auto">
            <div class="flex items-center gap-3 mb-2">
                <span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-widest">Espace de cours</span>
                <span class="text-slate-300">/</span>
                <span class="text-slate-500 text-[10px] font-medium uppercase tracking-widest">Technologie</span>
            </div>
            <h1 class="text-4xl font-black text-slate-900 tracking-tight mb-2">Mes ressources</h1>
            <p class="text-slate-500 max-w-2xl text-sm leading-relaxed">
                Supports de cours, vidéos, audios et activités interactives sur l'IA.
            </p>
        </div>
    </header>

    <main id="mainContent" class="max-w-5xl mx-auto px-4 py-12"></main>

    <!-- Template Ressource -->
    <template id="resourceTemplate">
        <div class="resource-card p-5 mb-4 shadow-sm flex flex-col md:flex-row gap-4 items-start md:items-center">
            <div class="thumbnail-container icon-box">
                <i class="fas fa-file text-slate-400 text-xl"></i>
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="type-badge select-type admin-btn-disabled">Vidéo</span>
                    <span class="local-label hidden text-[9px] bg-indigo-100 text-indigo-700 font-bold px-1.5 rounded uppercase">Distante</span>
                </div>
                <div class="group relative">
                    <h3 class="res-title font-bold text-slate-800 outline-none">Titre</h3>
                    <p class="res-desc text-sm text-slate-500 outline-none mb-1">Description...</p>
                    <!-- Affichage optimisé du nom du fichier -->
                    <div class="filename-container hidden mt-2 flex items-center gap-2">
                        <i class="filename-icon text-slate-800 text-xs"></i>
                        <span class="filename-text text-xs italic font-medium text-slate-900 truncate max-w-[300px]">nom_du_fichier.pdf</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-2 min-w-[170px]">
                <button class="open-resource bg-indigo-600 text-white py-2.5 rounded-lg font-bold text-xs hover:bg-indigo-700 transition shadow-md flex items-center justify-center gap-2">
                    <i class="btn-icon fas fa-eye"></i> <span class="btn-text">Voir</span>
                </button>
                <div class="flex gap-2">
                    <button class="edit-link admin-btn-disabled flex-1 bg-slate-100 py-2 rounded text-slate-600 hover:bg-indigo-50 flex items-center justify-center gap-1.5 text-[10px] font-bold border border-transparent transition">
                        <i class="fas fa-link"></i> Source
                    </button>
                    <button class="delete-res admin-btn-disabled w-10 bg-red-50 py-2 rounded text-red-400 hover:text-red-600 flex items-center justify-center transition">
                        <i class="fas fa-trash text-[10px]"></i>
                    </button>
                </div>
            </div>
        </div>
    </template>

    <script>
        const ADMIN_PWD = "admin";
        let isEditMode = false;
        let siteData = [];

        const typeConfig = {
            video: { label: 'Regarder la vidéo', icon: 'fa-play-circle', fileIcon: 'fa-file-video' },
            audio: { label: 'Écouter le son', icon: 'fa-headphones', fileIcon: 'fa-file-audio' },
            text: { label: 'Lire le document', icon: 'fa-file-alt', fileIcon: 'fa-file-pdf' },
            image: { label: 'Visualiser l\'image', icon: 'fa-image', fileIcon: 'fa-file-image' },
            interactive: { label: 'Lancer l\'activité', icon: 'fa-bolt', fileIcon: 'fa-file-code' }
        };

        function initDefaultData() {
            siteData = [
                { id: 'seance1', title: 'Séance 1 : Fondations', resources: [] },
                { id: 'seance2', title: 'Séance 2 : Apprentissage', resources: [] },
                { id: 'seance3', title: 'Séance 3 : Génération', resources: [] },
                { id: 'seance4', title: 'Séance 4 : Société', resources: [] }
            ];
        }

        const saved = localStorage.getItem('ia_lab_restored_v2');
        if(saved) {
            try { siteData = JSON.parse(saved); } catch(e) { initDefaultData(); }
        } else { initDefaultData(); }

        function save() {
            localStorage.setItem('ia_lab_restored_v2', JSON.stringify(siteData));
            const status = document.getElementById('saveStatus');
            if (status) {
                status.textContent = isEditMode ? "Enregistré ✓" : "Lecture seule";
                status.classList.toggle('text-green-500', isEditMode);
            }
        }

        function getYoutubeID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        async function getVideoThumbnail(videoUrl) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.src = videoUrl;
                video.crossOrigin = 'anonymous';
                video.currentTime = 1; 
                video.onloadeddata = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg'));
                };
                video.onerror = () => resolve(null);
            });
        }

        function openViewer(res) {
            const viewer = document.getElementById('viewerModal');
            const body = document.getElementById('viewerBody');
            document.getElementById('viewerTitle').textContent = res.title;
            document.getElementById('viewerType').textContent = res.type;
            document.getElementById('externalLink').href = res.url;
            body.innerHTML = '';

            if (!res.url || res.url === '#') {
                body.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center text-white p-8 text-center">
                    <i class="fas fa-cloud-upload-alt text-4xl mb-4 text-slate-600"></i>
                    <p class="font-bold">Aucune source liée</p>
                </div>`;
                viewer.style.display = 'flex';
                return;
            }

            const ytid = getYoutubeID(res.url);

            if (res.type === 'video') {
                if (res.isLocal) {
                    body.innerHTML = `<video controls autoplay class="w-full h-full bg-black"><source src="${res.url}"></video>`;
                } else if (ytid) {
                    body.innerHTML = `<iframe src="https://www.youtube.com/embed/${ytid}?rel=0&autoplay=1" class="w-full h-full border-0 relative z-10" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
                } else {
                    body.innerHTML = `<iframe src="${res.url}" class="w-full h-full border-0 bg-white"></iframe>`;
                }
            } else if (res.type === 'audio') {
                body.innerHTML = `
                <div class="audio-player-container">
                    <div class="audio-visualizer-mock">
                        ${Array(12).fill(0).map(() => `<div class="audio-bar" style="animation-delay: ${Math.random()}s"></div>`).join('')}
                    </div>
                    <i class="fas fa-music text-6xl text-indigo-400 mb-8"></i>
                    <audio controls autoplay class="w-full max-w-md">
                        <source src="${res.url}">
                    </audio>
                </div>`;
            } else if (res.type === 'image') {
                body.innerHTML = `<div class="w-full h-full flex items-center justify-center p-4 bg-slate-900"><img src="${res.url}" class="max-w-full max-h-full object-contain"></div>`;
            } else {
                body.innerHTML = `<iframe src="${res.url}" class="w-full h-full bg-white border-0"></iframe>`;
            }
            viewer.style.display = 'flex';
        }

        function render() {
            const container = document.getElementById('mainContent');
            const navLinks = document.getElementById('dynamicNavLinks');
            if (!container || !navLinks) return;
            
            container.innerHTML = '';
            navLinks.innerHTML = '';

            siteData.forEach((session, sIdx) => {
                const navLink = document.createElement('a');
                navLink.href = `#${session.id}`;
                navLink.className = "hover:text-indigo-600 transition truncate max-w-[120px]";
                navLink.textContent = session.title.includes(':') ? session.title.split(':')[1].trim() : session.title;
                navLinks.appendChild(navLink);

                const sSection = document.createElement('div');
                sSection.className = 'session-container';
                sSection.id = session.id;
                sSection.innerHTML = `
                    <div class="flex items-center gap-3 mb-6">
                        <h2 class="text-2xl font-black text-indigo-900 outline-none session-title">${session.title}</h2>
                    </div>
                    <div class="res-list space-y-4"></div>
                    <button class="add-res-btn admin-btn-disabled w-full border-2 border-dashed border-slate-300 py-4 rounded-2xl text-slate-400 font-bold hover:border-indigo-400 hover:text-indigo-600 transition mt-6">
                        <i class="fas fa-plus-circle mr-2"></i> Ajouter une ressource
                    </button>
                `;

                const titleEl = sSection.querySelector('.session-title');
                titleEl.contentEditable = isEditMode;
                titleEl.oninput = () => {
                    session.title = titleEl.innerText;
                    navLink.textContent = session.title.includes(':') ? session.title.split(':')[1].trim() : session.title;
                };
                titleEl.onblur = () => { save(); };

                const resList = sSection.querySelector('.res-list');
                session.resources.forEach((res, rIdx) => {
                    const temp = document.getElementById('resourceTemplate').content.cloneNode(true);
                    const card = temp.querySelector('.resource-card');
                    
                    const resTitle = card.querySelector('.res-title');
                    resTitle.textContent = res.title;
                    resTitle.contentEditable = isEditMode;
                    resTitle.onblur = (e) => { res.title = e.target.innerText; save(); };

                    const resDesc = card.querySelector('.res-desc');
                    resDesc.textContent = res.desc;
                    resDesc.contentEditable = isEditMode;
                    resDesc.onblur = (e) => { res.desc = e.target.innerText; save(); };

                    const filenameContainer = card.querySelector('.filename-container');
                    const filenameText = card.querySelector('.filename-text');
                    const filenameIcon = card.querySelector('.filename-icon');
                    
                    const thumbContainer = card.querySelector('.thumbnail-container');
                    const config = typeConfig[res.type] || typeConfig.text;
                    
                    if (res.isLocal && res.originalName) {
                        filenameContainer.classList.remove('hidden');
                        filenameText.textContent = res.originalName;
                        // Icône dynamique en fonction du type
                        filenameIcon.className = `filename-icon fas ${config.fileIcon} text-slate-800 text-xs`;
                    }

                    const badge = card.querySelector('.type-badge');
                    badge.textContent = res.type;
                    badge.className = `type-badge type-${res.type} select-type admin-btn-disabled`;
                    
                    if (res.thumbnail || (res.type === 'image' && res.isLocal)) {
                        thumbContainer.innerHTML = `<img src="${res.thumbnail || res.url}" alt="miniature">`;
                    } else {
                        thumbContainer.innerHTML = `<i class="fas ${config.icon} text-slate-400 text-xl"></i>`;
                    }

                    card.querySelector('.btn-text').textContent = config.label;
                    card.querySelector('.btn-icon').className = `btn-icon fas ${config.icon}`;
                    
                    if(res.isLocal) {
                        const localLabel = card.querySelector('.local-label');
                        localLabel.textContent = "Fichier Local";
                        localLabel.classList.remove('hidden');
                    }

                    card.querySelector('.open-resource').onclick = () => openViewer(res);
                    card.querySelector('.edit-link').onclick = () => {
                        window.currentEdit = { sIdx, rIdx };
                        document.getElementById('modalErrorMessage').classList.add('hidden');
                        document.getElementById('urlInput').value = res.isLocal ? '' : (res.url === '#' ? '' : res.url);
                        document.getElementById('fileInput').value = "";
                        document.getElementById('linkModal').style.display = 'flex';
                    };
                    card.querySelector('.delete-res').onclick = () => {
                        if(confirm("Supprimer cette ressource ?")) { session.resources.splice(rIdx, 1); save(); render(); }
                    };

                    card.querySelector('.select-type').onclick = () => {
                        const types = ['video', 'audio', 'text', 'image', 'interactive'];
                        res.type = types[(types.indexOf(res.type) + 1) % types.length];
                        save(); render();
                    };

                    resList.appendChild(card);
                });

                sSection.querySelector('.add-res-btn').onclick = () => {
                    session.resources.push({ type: 'text', title: 'Nouvelle ressource', desc: 'Description...', url: '#', isLocal: false, originalName: null });
                    save(); render();
                };

                container.appendChild(sSection);
            });
            updateToolbarUI();
        }

        function updateToolbarUI() {
            const icon = document.getElementById('lockIcon');
            const statusText = document.getElementById('editStatusText');
            const btnText = document.getElementById('btnText');
            const btnIcon = document.getElementById('lockBtnIcon');

            if (isEditMode) {
                document.body.classList.add('edit-mode');
                btnText.textContent = "Verrouiller le mode édition";
                btnIcon.className = 'fas fa-lock-open';
                icon.className = 'w-2 h-2 rounded-full bg-green-500';
                statusText.textContent = 'Mode Administrateur';
            } else {
                document.body.classList.remove('edit-mode');
                btnText.textContent = "Déverrouiller l'édition";
                btnIcon.className = 'fas fa-lock';
                icon.className = 'w-2 h-2 rounded-full bg-red-500';
                statusText.textContent = 'Mode Consultation';
            }
        }

        function showModalError(message) {
            const err = document.getElementById('modalErrorMessage');
            const modal = document.querySelector('#linkModal > div');
            err.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> ${message}`;
            err.classList.remove('hidden');
            modal.classList.add('error-shake');
            setTimeout(() => modal.classList.remove('error-shake'), 400);
        }

        document.getElementById('toggleEdit').onclick = () => {
            if(!isEditMode) document.getElementById('passwordModal').style.display = 'flex';
            else { isEditMode = false; render(); save(); }
        };

        document.getElementById('confirmPwd').onclick = () => {
            if(document.getElementById('adminPwd').value === ADMIN_PWD) {
                isEditMode = true;
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('adminPwd').value = '';
                render(); save();
            } else alert("Code incorrect");
        };

        document.getElementById('cancelPwd').onclick = () => document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('cancelLink').onclick = () => document.getElementById('linkModal').style.display = 'none';
        document.getElementById('closeViewer').onclick = () => {
            document.getElementById('viewerModal').style.display = 'none';
            document.getElementById('viewerBody').innerHTML = '';
        };

        document.getElementById('saveLink').onclick = () => {
            const url = document.getElementById('urlInput').value.trim();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const target = siteData[window.currentEdit.sIdx].resources[window.currentEdit.rIdx];

            if(!url && !file) {
                showModalError("Veuillez fournir un lien ou choisir un fichier.");
                return;
            }

            if(file) {
                const fileName = file.name;
                const ext = fileName.split('.').pop().toLowerCase();
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const result = e.target.result;
                    target.url = result;
                    target.isLocal = true;
                    target.originalName = fileName;
                    target.thumbnail = null; 

                    if (ext === 'mp4') {
                        target.type = 'video';
                        target.thumbnail = await getVideoThumbnail(result);
                    } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
                        target.type = 'audio';
                    } else if (ext === 'pdf') {
                        target.type = 'text';
                    } else {
                        target.type = 'image';
                    }
                    
                    save(); render();
                    document.getElementById('linkModal').style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                if (!url.startsWith('http')) {
                    showModalError("Lien invalide.");
                    return;
                }
                target.url = url;
                target.isLocal = false;
                target.thumbnail = null;
                if (getYoutubeID(url)) target.type = 'video';
                save(); render();
                document.getElementById('linkModal').style.display = 'none';
            }
        };

        render();
    </script>
</body>
</html>